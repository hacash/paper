Hacash 协议层技术架构设计哲学及对比以太坊
===

Hacash 白皮书的第九章“技术设计原则”中简要叙述了几项重点原则：简单、紧凑、可控和解耦。这是从整体上指导 Hacash 架构体系建设的总方针，包括代码组织、数据结构、储存层、状态层、协议层、执行层、P2P层、接口服务、矿工节点等各方面。

本文档着重于在协议层讨论 Hacash 的技术体系和建构原则，通过与以太坊的初始设计原则进行对比，结合 Vitalik 刚发布的一篇文章《 [Should Ethereum be okay with enshrining more things in the protocol](https://vitalik.eth.limo/general/2023/09/30/enshrinement.html) 》内的观点，对 Hacash 的技术思想进行阶段总结，期望形成一套能启发后续开发工作，并具有指向性意义的观点集合。

在进行具体探讨之前，有两个技术概念需要首先定义：

1. 协议层

又可以称为核心层，指区块链体系内由底层功能支持的实现，普通用户无法对这个层级进行修改或自定义，任何变更都需要核心开发者部署代码，并通知社区所有的参与者更新节点软件。总之，在全节点内硬编码的部分属于核心层。

2. 合约层

也可以称为用户层，指区块链体系内偏上层的用户需求或业务实现，普通用户可以通过部署合约、编写脚本等方式来自定义开发。需求的改变不需要升级节点软件，只需要用户更新合约即可。总之，无需底层协议改动就能满足需求变化的部分属于用户层。

后文将根据上下文意义按需切换使用 协议层/核心层 和 合约层/用户层 两组称谓。

### 以太坊初始设计原则

自以太坊创造伊始，就有一个强烈的理念，即试图使核心层尽可能简单，并通过在其上构建用户自定义代码来满足丰富多样的用户端需求。人们强烈希望创建一个干净、简单和美观的核心层，尽可能少地尝试通过更改底层来满足上层应用需求，并将几乎所有这类工作都留给上层和用户。理想情况下，协议只是一个通用的虚拟机，不包含任何用户业务需求，而验证一个区块只是一个虚拟机调用。这就是以太坊“世界计算机”愿景的设计方向，我们可以把这种技术路线称之为 “协议最小化”。

但 Vitalik 近期正在思考另外一种路线，一种基本否定了过去“最精简核心”的设计思路。在叙述这种路线的文章（链接见上文）里将其称之为“最小化封装”，并探讨其设计哲学和背后的哲学推理。目标将是开始建立一个原则性框架，以便更好地确定可能的目标，在这些目标中，能够判断封装某些功能可以值得考虑。

值得注意的是，“预编译合约”并不属于上文讨论的“封装”的概念之内，而是属于合约层编程语言的标准库或者Framework，还是处在用户层之内，只不过在安全性和性能优化方面经过了预先集中检验，其本质还是职能合约代码。

### Hacash 的技术路线

Vitalik 的 [新文章](https://vitalik.eth.limo/general/2023/09/30/enshrinement.html) 所讨论的大部分主题就是 Hacash 的技术路线选择。简要来说，文中所说“最小化封装”的重点，就是把可以在用户层（智能合约）实现的、最常用、最重要的某些大范围被使用的功能，下沉到核心层通过硬编码开发、封装好，用户无需再次部署自己版本的实现，只需要一行代码调用核心层接口即可使用。但相比 “最小化封装” ，有一个更能准确描述这种路线的词：“标准化封装” 。Hacash 主要通过 [层级股权控制账户](https://github.com/hacash/paper/blob/master/whitepaper.cn.md#3-%E5%B1%82%E7%BA%A7%E8%82%A1%E6%9D%83%E6%8E%A7%E5%88%B6%E8%B4%A6%E6%88%B7) 和 [可读金融合约](https://github.com/hacash/paper/blob/master/tech/readability_contract_introduction_cn.md) 来践行标准化封装这个技术路线。

Hacash 的终极愿景是“加密健全货币”，为满足货币的发行、支付及衍生的清算、应用等金融需求为基础而构建。这种以资产、价值叙事为导向的目标，与去中心化应用公链平台这种纯技术叙事，在架构设计上有着完全不同的考量和侧重。相比技术平台，货币金融的核心层更需要稳定、安全和简单、可靠，更加无法容忍出错，这意味着后者在灵活性上可能有所制约，比如在 Layer1 层不支持图灵完备的智能合约，或者将来只支持一种在可靠性方面严格设计的“安全智能合约”。

世界经济的货币核心承担不起崩溃的风险。Hacash 的开发目前虽然迭代迅速，但在未经时间检验的新概念、试验性技术的支持上必然持相对保守态度，但又不至于故步自封、拒绝一切。一种可行的思路是，让市场上其它创新型技术类公链作为 Hacash 的探路者和试验田，等相关新技术较为成熟时，经过严格分析、取长补短、综合考虑后，再给予高效、无风险支持，以始终维护一个去中心化、稳定、健全的货币核心为判断标准。

与以太坊的智能合约虚拟机（EVM）技术所呈现出的精简核心和全新理念不同，Hacash 的协议层看起来要“重”得多，由于包含了很多标准化合约功能的硬编码封装，使得这种折中的实现方式似乎显得缺乏某种极致的技术美感。但表面上性感的以太坊其实一点也不“轻”，EVM 的实现所涉及的开发量、复杂度和潜在bug风险，都要远远大于 Hacash 的所有“标准封装”加起来的程度。

如果再考虑到以太坊早期非常看好但未能实现的分片扩容技术，协议层的复杂度、工程量和测试流程都将远超“标准化封装”技术，毕竟后者在成体系后更多只是简单的工作量叠加和版本发布。这种看似不够前卫的技术路线源于 Hacash 的本质并不是为了成为一个以创新性技术平台为价值源泉的项目，而是追求货币范式革命，只不过刚好某些新技术可以作为工具使用。

### 优缺点对比

我们以 Hacash 的 [可读金融合约](https://github.com/hacash/paper/blob/master/tech/readability_contract_introduction_cn.md) 为代表的“标准化封装”路线和以太坊的`智能合约`为代表的“协议最小化”路线来进行对比，探讨两者在各方面的优势与不足，以便能更加直观地展现 Hacash 的技术哲学理念。

#### 标准化封装好处

1. 核心实现简洁

不需要发明整套庞大的智能合约虚拟机技术栈，一个非常小而美的精简结构就能搭建好核心层的关键部分，剩下的大部分工作都只是在思考和选择需要封装哪些标准化功能。所费开发时间大概不到实现一个 VM 的零头，更别说后续复杂的测试工作了。

2. 主网健壮性强

相同开发力量的投入，越简单的技术概念和代码结构，越能够得到多次、充分的审阅和测试，潜在的bug也就越少。也正是由于核心实现的快速、简洁性，可以采用不同的编程语言开发和运行多个版本的全节点，从注重安全的强类型静态语言到强调敏捷的脚本语言都能实现，这进一步大大降低了代码错误的可能性。在全网有多个不同版本全节点同时运行的情况下，如果其中某个版本包含了代码错误，也不会对主网造成灾难性影响，特别是当 PoW 作为区块链共识机制时，能够容许部分节点出错而不至于全网宕机。

多版本节点的另外一个附带优点，就是可以采用动态类型语言非常快速地开发出包含新功能或封装的测试版本，开发社区的讨论可以直接在已经能运行的试验性代码之上进行，从而免除过多的对技术概念进行解释和理解的沟通成本。事实上，在开发社区还十分微小的情况下，Hacash 也已经有了 Golang 和 Rust 两个语言的全节点版本。

3. 体验友好

由于标准化封装技术的简洁性和规范性，可读金融合约的底层接口就跟一段字段定义良好的 JSON 格式数据一样简单，用户可以直接通过直观阅读就能看懂和理解交易内正在发生什么。简单来说，可读金融合约跟实际经济生活中签署的合同没有太大区别：都是一些支付和条件的条目组合，形成一个不可分割的整体事务。用户可以像处理普通文本商业合同一样构建和理解可读金融合约的每一条款。

如果结合自然语言 AI 技术，用户可以通过输入一些交易意图的文字描述，或者直接口述需求，就能自动生成对应的可读性合约，并且能以最简单直观的接近自然语言的展示方式去检查合约的正确性。

4. 用户安全

智能合约本质上是一个虚拟机环境，需要通过代码才能直接交互，就算某些协议开发了网页界面以方便使用，但又带来了对UI开发商的中心化信任风险问题。而可读金融合约的对外接口就是一个包含事务列表的交易，不需要程序员编程、不依赖第三方写的代码，则不会引入相应bug和漏洞。

考虑到区块链交易的不可回退性，对于需要管理大量资金、财产的情况而言，能在自己能够直观理解的操作规程中独立进行，要比通过第三方的帮助才能处理要安全得多得多。每一个与外部接触的环节都是一个严重的风险点。

5. 审计简易

检验合约正确性不需要第三方专业代码审计机构，不需要懂代码，像阅读普通文本合同一样检查合约，条目清晰，所见即所得。由此可以节省大量的审计费用，并减少因为担忧交易不安全的心理负担。

6. 资源占用低

交易、区块、状态空间占用极小。实现同样合约功能，可读合约所需要区块空间可能就十几个字节，而智能合约往往需要部署一套合约代码，所需空间要大的多。长期累积起来将更容易带来“状态爆炸”问题，严重影响区块链网络的去中心化程度，最终变成“机房链”。

7. 交易费用低

可读合约因为没有一整套合约代码的基础支持数据，同样的区块空间能包含更多的相同需求交易，由于主网的费用竞争机制，在相同实际需求处理量的前提下，交易费用将更低。

8. 组合性风险低

智能合约的 DeFi 乐高存在组合性脆弱问题，假设每一个合约模块出现漏洞的概率为 10%， 那么十个合约组合起来的理论可靠程度则降低到了只有约35% ，这是难以接受的。可读合约的设计是在续期层面解耦并正交的，条目之间的任意组合，不会带来更高的崩溃风险。

9. 支持“链下博弈”

“链外博弈”节省区块状态空间。可读合约可以签署多个有资产关联的合约，这些合约可以由一些互斥的条目作为仲裁保证，导致不需要真的在主网上全部提交这些交易，就能达成某些金融支付保证，以节省区块状态空间。Vitalik 曾撰文描述过这一技术。

10. 沟通成本低

协议标准的统一能极大降低沟通成本。对主流金融需求的满足是由一套相同的主网代码保证，参与方不需要耗费精力去理解各种智能合约之间的差异和细节，也无需由专业程序员来翻译合约内部到底做了什么。一切沟通都在一套相同的概念上下文中高效进行。

如需在技术层面理解 Hacash 可读金融合约的技术原理及交易结构，可查看文档： [Hacash 可读金融合约简介及技术说明](https://github.com/hacash/paper/blob/master/tech/readability_contract_introduction_cn.md) ，里面通过创造两个简单的合约示例来解释。

#### 协议最小化优点

尽管以智能合约为代表的“协议最小化”技术有着各方点的缺点，但其仍旧具备一些优势，主要体现在三个方面：

1. 核心开发目标更单一

虽然智能合约虚拟机技术栈非常庞大且复杂，但这套技术基本可以视作一个单一目标。构建完成和运行成熟后，几乎不需要特别大的修改就能持续运行，这意味着某种意义上 VM 的核心开发组可以“躺平”了，只需要日常处理一些性能优化工作。

而可读合约在早期，相对来说需要持续不断的标准化讨论和封装开发，虽然也将会在多数需求都得到满足后能降低这种新工作的频次，但理论上还是需要持续更新。这意味着可读合约需要依赖一个更加活跃并可以持续不断活跃的核心开发组，我们无法下结论在当今的加密行业内，需要更加活跃的核心技术团队在市场层面会不会反而是一件好事。

2. 用户需求满足更快更全面

可读合约能满足的需求是更加通用且标准化的，如果用户端存在更加特殊的定制化功能，则相比提交需求并等待核心开发组的讨论实现，自己动手写合约代码就能更加直接快速地得到满足。

或许以后 Hacash 可以通过更加灵活、可自定义编码的“安全智能合约”来更加全面地适配独特的用户需求。

3. 社区项目演进更丰富

由于智能合约的图灵完备性，理论上能实现的功能几乎是无限制的，这就带来了丰富且无边界的各类项目的自由构建和采用，支持智能合约的公链可以成长出更加丰富多彩的生态系统，通过尝试各种各样的可能，有机会诞生某些意想不到的新种类。相对来说，可读合约的强目标性（基本就是指向货币和金融需求）约束下的生态可能会显得单调一些，尽管后者的重要性程度一点也不弱于前者。

---

随着区块链和加密技术的不断演进，上述某些问题可能会被解决，不同技术路线也可能通过不断的更改、优化和补足自身的缺陷方面，逐渐向对方逐渐靠拢，最终形成一种殊途同归的局面。但这并不妨碍我们咱在初始设计的原则里，从各自相对的视角中理解不同技术路线的关键考虑和哲学路线。






