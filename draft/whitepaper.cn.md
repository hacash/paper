Hacash：一种大规模支付实时清算的电子金融货币系统
===

【摘要】
---

本文提出了一种运用通道链有序多签名实时冲销结算方法，可无上限扩充每秒交易量，能掠夺性惩罚不诚实一方从而确保资金安全和实时到账的点对点现代电子货币发行支付体系。内建多重签名地址和层级股权控制地址、多方签署交易结构、全类别支付协议及资产变更协议，满足现代金融、企业及个人的绝大部分支付需求。结合了工作量证明、资金抵押及分叉投票的抢占式记账权奖励分配方式，能有效规避双重支付、防范算力攻击和降低马太效应。并采取符合经济规律的货币增量发行算法、公账及通道手续费和区块宝石等激励机制，无需委托信任于任何机构即可维持系统整体长期有效运转。

通道链清算网络的基本原理是：每两个账号各自锁定若干资金，组成一个支付通道，私下高频多次支付并双方签名，期间无需向全网广播交易，只需最后一次向主网广播最终的余额分配即可取回各自正确拥有的资金，从而极大地扩充整个系统的每秒交易数量；如果单方结束通道，则其资金会被锁定一段时间，如果另一方在此期间内向主网举证更加新的余额分配从而证实对方作假欺诈，则揭露方将会夺取对方全部资金，从而迫使双方保持诚实守信；只需将多个支付通道连接起来，并从收款方开始让所有资金流转方有序签名直至付款者最终签署，则所有相关方将同时收到和付出资金，从而确保支付完整、实时到账和资金安全；通道可收取微量手续费激励其提供稳定服务。

目录
---

一、前言
  1. 危机
  2. 货币的未来
  3. 我们需要什么

二、基本原理
  1. 技术理论
  2. 自利原则
  3. 不足

三、通道链清算网络
  1. 基本假设
  2. 主要原理
  3. 技术实现
  4. 通道关闭
  5. 仲裁保护
  6. 收付平账
  7. 反集中化
  8. 资金计算

四、交易
  1. 基本数据结构
  2. 多重签名地址
  3. 层级股权控制地址
  4. 多方签署
  5. 支付类别
  6. 签名剥离
  7. 手续费
  8. 标准协议
  
五、激励
  1. 记账权竞争奖励
  2. 手续费
  3. 通道费
  4. 区块钻石
  5. 数据服务

六、货币
  . 总量及增长
  . 无限分割
  . 单位及符号
  . 禁止动态货币政策

七、隐私
  1. 匿名
  2. 支付混搅
  3. 私有通道网
  4. 通道冲销

八、设计原则
  1. 简单直观
  2. 执行高效
  3. 数据紧凑
  4. 主链数据保持精简且增长可预估
  5. 可剥离及压缩
  6. 统一协议标准

九、缺陷、风险与防范
  1. 通道链延迟签名攻击
  2. 无成本通道违约
  3. 通道信用货币创造
  4. 算力集中化与51%攻击
  5. 价格极端波动

十、结论

【附录】
  1. 参考引用
  2. 区块数据结构定义完整示例及注释
  3. 部分算法代码


---

一、前言
---

### 1. 危机

我们走到了货币体系变革的时代关口。

纵观历史，文明发展和经济进步总伴随一个前提：文化和金融自由。无论资本主义还是社会主义，无论发达国家还是发展中国家，周期性出现的经济危机却让人们对金融体系施行更加严厉管制的呼声越来越高。究其本源，不同的现代社会经济体制都有一个共同点：强制性主权信用货币和银行部分准备金制度。这本质上是一种欺诈，是金融不稳定的根源，是除暴力掠夺之外导致利益分配不公的最大缘由。随之必然而来的经济干预政策极尽推波助澜或矫枉过正，如同王朝更迭一样反复伤害原本该渐进增长的经济体和人们的生活水平。

不稳定、不可预期、人为肆意干预和操控的金融环境，将使得大型资本在根本不必进入实体经济的情况下即可轻松获得超额增值。当资本特别是巨型资本的回报率超过甚至远超长期整体经济发展的平均回报水平时，贫富差距就会不可避免的地加速拉大，直至社会矛盾加剧、经济危机和动乱。如果某一代人刚好在长达十年甚至二十年的大萧条起始时成年，那么他们的命运将注定艰难困苦、碌碌无为。这非常不公平，为何前一代人的贪婪、愚蠢和疯狂，却要下一代来承担后果？为了抹平这种周期性危机导致的严重代际不公（或许因此带来更严重的社会动乱、革命甚至战争），采取经济干预和刺激政策，注入兴奋剂成了一个痛苦的权宜之计。不过，面对不利的人口与债务趋势，不可能通过短期的刺激手段应对长期的结构性危机，这根本就是在自欺欺人。

如果，我们能够从根本上解决问题，避免或大幅减少金融危机和经济崩溃呢？

中国北宋时由于政府在四川地区强制使用铁质钱币造成的笨重不便，民间出现了原始的纸币：交子，这似乎是一种货币金融的“进步”。当时的政权发现这简直是完美的税收工具，随即将纸币发行权收归国有，不用再耗费大量财力物力丈量土地、清点户籍、收钱造册，只需轻轻开动印刷机，就能悄无声息源源不断地从民间抽取大量财富。但随之而来的反复超级通货膨胀和经济崩溃打破了王朝的如意算盘，终于在明代初年间人们彻底不再相信任何纸片，退回到了贵金属货币时代，甚至大家直接通过分割和称重散碎银两来进行交易。这种看起来像退化到了原始的货币状态却给了民间极大的金融和经济自由度，成就了中国历史上少有的金融稳定时期，普通百姓生活水平得到提升，这种情况一直持续到清朝后期。

货币来源于市场，并终将服务于市场。其形态本身并没有高低极之分，也没有绝对的好与坏，只有是否更加适应及高效。我们需要一个自由竞争、适者生存的货币市场和开放透明、避免欺诈的金融环境。这个世界上的不公本质上是信息的不公。

### 2. 货币的未来

黄金本是地球上最适合成为货币的物品，但是人们现在却没有使用它进行大规模的交易支付。主要原因有：1. 笨重不便于携带；2. 不可无限分割用于小额支付；3. 长期流通造成磨损耗费；4. 造假掺假技术越发强大。请注意，储量有限并不是它的缺点。在欧洲历史上曾长期使用黄金作为储备的纸币进行流通，这种方式表面上兼具黄金的优点却规避了其作为日常支付手段的缺陷。只不过，没有任何个人和组织禁得住凭空创造钱的诱惑，无论承诺多么坚决，纸币总是会被超发。与历史上在金、银、铜币里掺杂其他金属故意造成贬值的情况别无二致，甚至由于发行成本的极度降低造成严重通货膨胀从而导致经济的崩溃。这种情况曾反复多次出现。

阻止黄金作为通用支付手段的另外两大具备争议的问题是：1. 储量位置分布不均，地下有金矿的国家相当于坐收全世界的税；2. 无法在经济的增长率和规模大幅变动之时快速调节供应量，容易造成紧缩和钱荒。特别是关于第2点的争论已大量见于奥地利、现代货币和凯恩斯等各个经济学派的著作之中，其中一些认为信用扩张是经济危机的根源、是洪水猛兽，而另一些则坚定认为没有“弹性”的货币将会锁死整个经济的发展。

历史上，货币大致经历了如下几个种类或阶段（并不代表严格分类、出现的先后顺序或本质优劣）：

	1. 通用价值物（谷物、布帛、牛羊、香烟等）
	2. 稀有稳态物（金、银、铜、宝石、贝壳等）
	3. 信托账务凭证（存款证明、债务凭证、匿名支票、商品券、纸黄金等）
	4. 主权信用符号（法币）

其中第1、2阶段由于无法满足现代商业支付需要而被逐渐淘汰，第3阶段似乎会造成信用膨胀和银行家欺诈带来的经济脆弱及崩溃，人们随即期望政府设立的央行机构体系解决问题（或者更有利于政府），于是走入了第4个阶段，但效果如大家所见，并不遂人意。

我们认为，货币的未来，也就是第5阶段的形态将会是「公认规则」为主体、骨干，「个体信用」为分支、补充的开放性电子网络体系，并且会在自由竞争的过程中持续改进和显现出最优的系统。这种「公认规则」不以任何人的意志、权力为转移，不受任何机构的控制，就像没有人能够凭空创造出黄金一样，公平的规则能让全世界有效的参与进来。货币远不止是一般等价物，它还是一种信号，是经济运转的信息系统。我们可以忍受和修复局部信用失效，但绝对无法承担整体信用崩塌的后果。

2008年，比特币（Bitcoin）以及背后区块链技术的出现和十年来的有效运转为我们指明了方向。

### 3. 我们需要什么

区块链的核心价值并不在去中心化，也不在永久保存数据，更不在逃避监管，而是在于去信任化。

比特币的出现并不是为了提升局部暂时支付效率或者减少部分瞬时交易成本，而是为了避免或降低辜负我们信任的企业与机构作恶的后果。它的愿景是完全匿名与去中心点对点信任，而区块链的未来则是公开透明与分布式自审计信任。

正如互联网满足了人类信息通讯的基础需要一样，区块链是为了解决困扰人类几十万年的大问题：欺诈。我们历史上为此付出了巨大成本，消耗了无数资源，阻断了太多交易。所以我们不能在未来的货币体系中加入任何欺诈的可能性，上帝保证也不行。

我们需要一种货币，没有人能肆意降低它的成色，可以更好的维护经济系统的稳定发展，并且完全能满足现代商业支付、企业财账及金融清算的需要。


二、基本原理
---

### 1. 技术理论

货币需要相对的稀有排他性，没有人会把水、土壤或者树叶作为交易媒介。然而在电子信息世界里，一切都是可几乎无成本复制。那么以二进制数据为载体的货币就有着一个致命的本质缺陷：数量无限且真假难辨。如果我们仍然依赖一个在线发行机构或电子造币厂确保钱币的真实有效和数量上限，那么从历史经验来看，没有谁能忍受凭空创造钱的诱惑，最终大家手里的东西将会一文不值。

一种直观就能想到的解决方案是将每一枚电子货币都编上整数号码，并公布一个号码的上限（或者这个上限每年自动增长固定数额），然后用电子签名的方式标注上每一枚货币的拥有者（先忽略谁最先拥有这些货币的问题），然后每一枚货币在支付的同时，都将由当前拥有者用私钥签名接收者的公钥，表明此枚钱币已经支付给对方，并保留所有历史支付记录。如此则解决了电子货币复制造假和数量无限的问题。

但是上文提出的方案有几个显而易见的缺陷：

    1. 不能被分割用作小额支付或找零；
    2. 同一枚钱币可被同一时间支付给不同的两个人甚至更多人（双花）；

缺陷1可以用足够小额的面值（编号上限足够大）来解决。而双花问题则比较麻烦，一种办法是让一个公共的中心机构来保存及证明每一笔支付的记录，但却仍然依赖机构负责人的正直诚信，且其有被迫欺诈的可能。另一种办法是通过广播，让所有人都各自拥有一份账本，列出所有人每一笔支付的记录，当接收钱币时即在自己的账本上查询钱币的拥有者，以此避免双花。

每个人都有一份账本的方案看似解决了双花问题，但仍然具备很大的缺陷：

    1. 维护一套账本不间断记录所有支付是需要耗费很大成本的，不经常收到钱币的个人实时维护一整套账本显然得不偿失。最后大家还是会依赖一些大的类似银行的机构出具的账本。
    2. 当有一些支付因为广播的技术原因并未到达所有账本记录者（比如海底光缆被切断），大家各自的账本记录就会不一致。长时间便会形成大量的不同版本，大家彼此不相认同，最终支付体系崩溃。
    3. 如果每个人花费很大成本维护账本只是为了自己在收钱时查询有效性，那么这种货币系统未免太过低效，并且最终会因为搭便车问题导致账本无人维护。

当然，还有一个最为关键的问题：谁应该最先拥有这些电子货币？

### 2. 自利原则

长期来看，任何单方面寄希望于对方的正直诚实和信守承诺，而没有其他激励和制衡的合作体系，终将不可持续。

而不断地有效运转的社会合作系统，无一不是正确面对人性的贪婪和自利，并加以利用让其用于维护体系的自我运行。比特币走在了正确的道路上并于期十年的发展中越发壮大。它通过创造性地将账本记录和货币发行两者结合起来，为大家维护账本提供了充足的动机，并采取工作量证明竞争记账权的方式让所有人的账本始终保持统一，从而巧妙的解决了上文所面临缺陷。当然它也并没有使用为每一枚钱币编码的体系，而采用了未花费余额（UTXO）的方式支持小额支付和找零。关于比特币的详细理论这里并不过多介绍，大家请参阅中本聪的论文。

### 3. 不足

天下没有免费的午餐，也并无完美无暇的碧玉。正如我们上文一直以来的“提出问题-解决问题-遇到新问题”的推导一样，公开竞争记账的货币体系仍然有两个大家所诟病的缺点：

    1. 通过哈希算法重复运算竞争一定时间内的账目记录权从而获得增发的货币奖励的方式耗费了大量的硬件及能源。
    2. 由于需要向所有账本记录人广播每一笔支付并得到确认，导致总体支付效率非常低下（大约每秒7笔），并且需要支付高昂的手续费，根本无法满足现代商业的需要。

严格来说，我们并不认为第1点是真正的缺点。除了短期内的投机和非理性繁荣，在一个没有强制性的自由竞争领域，大家总会找到一个成本和收益的平衡点，我们使用了大量能源和精力，并不是因为我们疯了，而是这样做总体上有利可图，耗费的成本终将在其它方面更多的补偿回来。正如我们并没有用尽全力把地球上所有的石油和黄金全部都开采出来一样，因为这么做不经济。

关于消耗能源（其他任何形式的资源）和避免受害这两者之间，只能做一个权衡：

    1. 大家平时不必付出任何成本即可享受免费、方便的好处，代价是提供服务的中心机构拥有作恶的风险，或者在其它不易看到的地方损害了大家的利益。
    2. 平时付出一定的成本（费用或精力），避免了有人或组织欺诈自己的风险。
    
如果有人宣称同时实现了以上两点（既免费又安全），要么没能认识到问题的本质，要么就是不怀好心。

可暂时延缓第2个缺点最直观的办法是扩容，即扩充区块大小上限或减少区块生成间隔时间，但这无法从根本上解决问题。区块大小具备理论上限，数量太大会加长下载传输同步的时间，这进一步限制了区块间隔时间的上限。这是一个水涨船高的过程，新的交易总会填满扩充的空间，而全世界的交易支付量远大于当前受硬件体系制约的扩容理论上限。另一方面，数据量扩大到一定程度，也会导致普通个人计算机无法装下完整的账本，最终淘汰绝大部分参与者，数据向财力雄厚的某些大机构聚拢。

另一种某些改进者正在尝试的方案是：极度缩减账本记录者的总数量（比如21个或101个），对他们的工具性能提出比较高的要求，并将新增钱币给予他们以此鼓励，整个系统便能承载很大的交易量。这看起来令人欢欣鼓舞，然而如前文所说，这种形式有它不可规避的缺点，其本质上与历史中的铸币厂分局体系无太多区别。

也有一些人希望通过容忍临时的数据不一致性，换来整体系统吞吐量的极大提升（广义的DAG结构），这只能应用于对数据真实性要求不严格或不需立即验证的场景内，而在一个小额即时支付系统里是完全不可靠的。

也许是不认为这是个麻烦，也许是暂时没考虑清楚而刻意略过，中本聪也没有在论文中指明如何承载巨大交易量的解决方案。


三、通道链清算网络
---

### 1. 基本假设

参照显示世界的运转，成年健壮男子可轻松抢夺街上妇女儿童的财货占为己有，可多数人并没有这么做，是因为大家知道，背后的警察和法律体系将让其付出更大的代价，从而让这种作恶行为得不偿失。事实证明，就算存在风险，只要具备严格的惩罚机制，大家的理性驱利行为将维持系统总体的有效运行。

我们提出，公共账本不应该包含全部的交易支付记录，而应该作为一个严格准确有效且不能被操控的仲裁体系和最终清算系统，保证在私下进行的支付行为不能欺诈，否则即给予严厉的惩罚，在无限次数重复博弈中，大家会倾向于保持诚实来长期合作。这种体系能极大的动态按需增加交易量，并在理论上没有上限，从而能完全应对现代商业发展的需要。

### 2. 主要原理

我们需要实现一个能实时到账、没有任何人会丢失资金的小额高频支付系统，可用于网络商城或实体商店中的购买行为。如果有中间人提供资金服务，那么所有人都应该同时保证收支的正确。要点在于，资金链条的结算应该是实时同步而不能为异步，否则将带来严重的中心化和资金安全问题。

首先，我们需要创建一系列的双向结算通道，他们分别是顾客和资金通道服务者（简称节点）、商家和节点，必要时顾客和商家可直接建立结算通道。发起支付时，由商家或服务商家的节点查询资金通道链条的路由，并建立整个链条的TCP连接，然后从所有节点处取得所有的通道ID、上一笔交易hash、交易序号、余额确认等信息后，建立一个完整的交易，并发送给所有参与方。接着从商家开始，按顺序，所有人将自己对这笔支付交易的签名发送给所有其他方，直到顾客的签名都被大家收到，此时商家签署交易确认的消息，从链条结尾有序关闭所有TCP连接，此时所有相关放都同时收到（和支出）了资金，支付完成。没有个通道可收取微量的服务手续费用，以此激励节点提供稳定的服务。

### 3. 技术实现

下文描述了所有的技术细节以及每一步完成后的数据状态。

#### 1) 创建联对式结算通道

```js
{
    // 开启一条结算通道，fund1和fund2为出资双方
    // 通道一旦开启将扣除双方的余额，直到通道关闭
    // 结算通道单方终结的锁定期限（区块数量）
    lock: 2016, // 约等于于一周
    // 结算通道自定义id，随机生成
    channelId: 232353253456,
    fund1: {
        address: '1313Rta8Ce99H7N5iKbGq7xp13BbAdQHmD', // 出资地址
        amount: 1234, // 出资数量
    },
    fund2: {
        address: '19aqbMhiK6F2s53gNp2ghoT4EezFFPpXuM',
        amount: 1234,
    },
}
```

双方都签署以上交易，将其广播到主网得到确认后，便可在私下进行不限次数和频率的双向支付，在这之后产生的所有交易，都无需向主网广播。

#### 2) 私下结算

每一次支付，双方都同时签署结算信息并交换签名结果，交易结构类似于：

```js
{
    // 【链下结算】阶段性余额分配确认
    // 如果在链上提交阶段性余额分配，地址将被锁定约定的时间，
    // 结算通道id
    channelId: 232353253456,
    //  上一笔确认的通道交易hash（首笔的话本字段为交易通道开启所在交易的hash）
    prevTrsHash: Buffer.alloc(32),
    // 通道交易序号，自动增量
    autoincrement: 123135,
    // 冲销后资金分配确认（一方比另一方多出的部分）
    diffConfirm: {
        address: '1313Rta8Ce99H7N5iKbGq7xp13BbAdQHmD',
        amount: 1234,
    }
}
```

如果每位顾客和每家商店都签署结算通道，这样将过于麻烦，并且会锁定太多资金。我们设想一些可以专门提供通道连接服务的节点，并且相互组成通道链结算网络，商家和顾客只需要跟少量的两三个个节点签署结算通道，就可通过此网络方便的与其他所有人进行交易支付，类似于访问互联网时你只需要接入一家宽带运营商，而无需和其他所有人各自单独拉一条网线。

#### 3) 通道链路由

我们假设顾客A与节点甲签署了一个通道，商户D和节点乙签署了通道，而节点甲与节点乙也创建了结算通道。这时顾客若要支付给商户D，资金将通过一个A、甲、乙、D组成的链条流动到D的地址上，我们通过节点之间的询问查找（或第三方的路由查询，类似域名DNS服务器），找出一条可能的最短（或手续费最低）的路径，并按顺序组成TCP连接的双向通路：

    A <=> 甲 <=> 乙 <=> D
    
#### 4) 构建链式支付交易

由上面可以看出，顾客A的付款资金通过甲、乙两个节点，直到商家D要经过三个结算通道。此时，由商家的服务节点乙询问，或者各自主动双向广播的方式，所有参与方都获得了每一个结算通道的ID、交易序号、手续费、余额确认等信息，并进行了确认。然后，由商家D构建了一笔通道链支付交易，类似如下结构：

```js
{
    // 通道转账交易
    amount: 1234, // 支付金额
    // 途径的通道
    channels: [{
        // 结算通道自定义id
        channelId: 232353253456,
        //  上一笔双方确认的交易hash
        prevTransactionHash: Buffer.alloc(32),
        // 通道交易序号，自动增量
        autoincrement: 123135,
        // 通道手续费，可以为零
        fee: 12,
        // 本笔交易完成时的通道差额确认
        diffConfirm: {
            address: '19aqbMhiK6F2s53gNp2ghoT4EezFFPpXuM',
            amount: 1234, // 金额
        },
    }],
}

// 以上数据仅为示例， `channels` 字段的数组元素数量将为多个，此处已省略

```

以上交易数据将广播到所有参与方，每一个通道只取`channels`数组中单独一个元素作为结算凭证。节点甲、乙因为同时各自拥有两条通道，即可同时收到和支出资金，保持了收付平衡，并且没有人会因为其他节点的故障或下线而丢钱。

#### 5) 有序签名

所有人都收到了这笔交易，并进行了确认，如果有信息、资金或技术错误，任何一方都可断开TCP连接，从而关闭整个通道链。

此时进入签名阶段：

    1. 商家D首先用私钥签署这笔交易，然后将签名发送给节点乙
    2. 节点乙收到D的签名，验证无误后转发给节点甲，然后自己也签署交易并将结果发送给甲和D
    3. 接下来是节点甲，重复乙的行为，转发D、乙的签名，自己签署交易并广播
    4. 此时包括顾客A在内的所有方都收到了D、乙和甲的签名，整个通道处于等待顾客A的签名的状态

必须从商家D开始按资金流动方向逆序签名的原因是：收款签名依赖于付款签名才能生效，节点必须先确认对方已经签署收到资金，才能签署付款，整个过程链式传递。而顾客和商家必须确认通道链中所有节点都签署了交易，付款后资金才能整体实时到账，否则有可能顾客已经签名付款，而商家迟迟得不到确认。

#### 6) 收款回执

整个交易和通道的状态此时依赖于顾客A的签名，便同时全部生效：

    1. 顾客A收到了交易数据和商家D、乙、甲的所有签名，验证并确认无误
    2. A签署交易，将签名结果发送给甲
    3. 甲收到签名，转发给乙，乙转发给商家D，整个结算通道完成
    4. D用私钥签署一条消息表示收到此笔付款并确认成功，将结果发送给节点乙，之后断开TCP连接
    5. 乙将付款成功消息转发给甲，之后断开连接，甲转发给A，并断开连接
    6. 顾客A收到商家D的回执，整个通道链结算全部完成，所有连接断开
    
#### 8) 通道各自结算及手续费

通道链中的每一个单独的通道，双方都收到了一个完整的交易，包含了资金在整个链条的所有流转记录。各自只需要去`channels`数组里面与自己匹配的通道做结算，结算金额为顾客A付款额度减去之前所有通道的手续费。

每个通道可以收取很少量的手续费（`fee`字段），达成资金占用的类似于借贷利息的收益，通常手续费的比例取决于两点：1.资金的额度大小；2.硬件网络服务成本；手续费可以为零甚至可以为负，提供负手续费的通道一笔交易收到的资金将低于同时的支出，这可以视为一种吸引顾客开拓市场的补贴手段。

#### 9) 错误处理

我们必须保证资金同步实时到账，并且没有人会因此可能受到损失。如果在支付的过程中，任何一方出现任何错误或问题，都将终止整个通道链的支付，断开所有连接：

    1. 技术故障导致任何一方在拿到最终收款回执之前断开了连接，则通道链终止
    2. 签名校验失败，终止
    3. 支付额度或手续费不正确，终止
    4. 交易序号、上一笔结算hash或余额确认不正确，终止
    5. 签名超时，终止

节点或商家可自定义一个超时时间（比如10秒），过期没有收到后续签名或回执，则断开TCP，终止整个通道链。目的是避免不完整交易，从而导致某一方丢失资金。

通过以上数据交换流程，我们完成了整个支付行为，各方都是实时安全到账。中间节点也可以收取微量手续费，激励其提供稳定的服务。

### 4. 通道关闭

一个通道在一段时间内会签署大量的支付，反复多次双向付款。如果双方对最终的余额分配没有争议，即可签署一条表示最后终止通道并提取各自余额的交易，广播给全网确认：

```js
{
    // 双方确认余额，关闭结算通道
    // 余额分配立即生效，没有锁定期
    // 结算通道id
    channelId: 232353253456,
    // 确认余额分配 diffConfirm 为两者相差余额额度
    diffConfirm: {
        address: '19aqbMhiK6F2s53gNp2ghoT4EezFFPpXuM',
        amount: 1234, // 金额
    },
}
```

以上交易在主网上一经确认，锁定在结算通道内的资金则立刻返回给双方。

### 5. 仲裁保护

由于结算通道是双方联对锁定资金，如果一方丢失私钥，将拖累另一方也无法将通道内自有的资金解锁并提出。也考虑到某一方恶意不签署关闭通道的交易，或其他原因导致暂时无法合作，我们需要能够单方面终止通道。

办法是将最近的一笔通道链支付交易（或对账交易，且包含多方签名）通过引用方式广播给主网进行确认，通过交易内明确的余额，对方（被动终止方）将立即收到资金，而提起结束通道的一方（主动终止方）也解锁了资金，但代价是账户将锁定事先约定的时间（`lock`字段，例如一周），在此时间段内无法转出余额，作为避免单方面随意（恶意）结束通道的惩罚机制。

如果某一方向主网提交了不是最新的余额分配却对自己有利的一笔交易，想要单方面终止通道并侵占对方的资金，如上文所示提交方账户将被锁定而无法转出余额，此时另一方可以向主网提交最新的余额确认（通过交易自增序号`autoincrement`判断），一旦被证实则后者将立即夺取前者的所有资金，包括通道内的全部以及锁定的余额。通过严厉的作恶惩罚和举证奖励（后发优势对等博弈）让双方保持诚实。

考虑到消费或工资结算通道内的一方出资可能为0，或者最终一方支出了所有资金，那么作恶的成本为在主网提交通道交易锁花费的手续费，但一旦侵占成功则将获得很大收益，一些账户会在这种情况下选择作恶。此时可以采用账户锁定保证金的方式，在主网上锁定一定额度的资金作为多个结算通道的作恶赔偿金。

诚实的一方单方面结束通道，代价是账户被锁定约定的时间，而由于另一方无法给出（不存在）更新的余额分配，双方都不会损失资金。通过无限次重复对等博弈，大家都会倾向于选择诚实并合作。

### 6. 收付平账

设想如下情况：某商家首先与某通道服务节点签署了一个收款通道，接受Hacash资金的付款。此时商家在此通道的出资应为零。一段时间后，顾客通过结算网络向商家支付了一定量的资金。然后商家与节点签署了一个付款通道，用于采购或支付工资，此时节点的通道出资应为零。

为了方便会计报表，这两个通道均为单向支付通道，一个仅用来收款，另一个仅支出。但通道锁定的资金是有上限的，而且为提高资金利用率，数量也不会太大。一段时间后通道内的资金将全部转移到了另一方账户导致交易无法继续，此时只能由另一方在主网上不断的追加通道资金，或干脆关闭后重新开启一个额度更大的结算通道。因为要等待主网的确认和支付相当的手续费，这将是非常低效的，而且将会锁定大量越来越多的资金，长此以往整个系统将无法承受。

这个问题也会出现在个人的消费通道和工资通道分离的情况下。

我们使用一种通道对冲平账的方法来解决这个问题，底层技术原理与通道链支付交易相同。只是在这笔对冲交易中，仅包含收付两个通道，此时商家和节点（或个人与节点、节点与节点）之间同时互为支付和收款，交易结构类似于：

```js
{
    amount: 1234, // 支付金额
    // 途径的通道
    channels: [
        {
            // 结算通道自定义id
            channelId: 1111,
            /**
             * 商家的收款通道，转移资金至节点
             */
        },
        {
            // 结算通道自定义id
            channelId: 2222,
            /**
             * 商家的支付通道，从节点把收款通道转出的资金再转回来
             */
        },       
    ],
}
```

这笔交易达成的结果为：商家的收款通道的余额被转移进了支付通道，而且是原子操作，双方都没有损失资金的风险。

所有参与方，都可以定期进行对冲平账，不需要频繁与主网交互和锁定太多资金，从而让整个结算网络始终处于高利用率状态，只需少量资金便可支撑极大规模的支付交易。

### 7. 反集中化

规模优势和信息不透明致使我们无法完全避免金融与数据中介的存在，但准入制与垄断可以让马车夫变成拦路的山贼，过度集中化将导致严重的单点崩溃、抽税效应和信任危机。

如比特币的闪电网络，如果大部分交易都集中到少数几个中介点进行资金流转，那它们就成为了事实上的银行。一旦某个节点出现故障，将瞬间导致大量的交易无法进行，滞留在这些通道中的资金将爆炸性的向主网提交解锁，造成严重的拥堵和费用飙升，那些金额较低的通道甚至不足以抵扣提现的手续费。

我们应当尽量避免集中枢纽化，通道链清算网络有两点特性可规避此问题：

#### 1) 链内资金结算整体实时到账

一旦付款方签署交易，所有参与方资金立刻全部同时到账和支出，不会滞留堆积在任何中间节点的通道内，就算技术故障或其它不可抗力导致节点下线，也不会影响在此之间已经达成的交易。

#### 2) 通道签付锁定期

一条通道同一时间只支持单笔交易的达成，而无法做到并发收付，这在一定程度上降低了交易规模。但这有几个极大的优势：1.资金安全保证；2.对账简便明确；3.交易不会堵塞；4.避免中心枢纽节点；

其中第4点的原理是：在连接TCP后至取得付款方最终签署交易的期间，相关通道一直处于锁定状态（此间无法同时支持其他交易，锁定时间可能为上百毫秒），单一通道的每秒交易量瓶颈，使得想要锁定巨量资金以满足大部分支付需求的枢纽通道变得极为不划算，最终会形成大量小额通道提供完全分散化服务的局面，从而避免了单点故障和中心化危机。

通道分散化、单通道金额的降低也带来了另外一个好处：让侵占资金的损人利己行为变得不再具有吸引力。

### 8. 资金计算

假设平均一次支付要经过两个中间节点连接的三条通道，我们可以计算:

    T:总锁定时间 = N:通道数量 * S:数据步骤 * ( t:TCP传输耗时 + c:验证计算耗时 )

代入得：3 * 3 * (20ms + 15ms) = 315ms，即表示结算网络平均每秒可支持三笔交易。如果有100个单位的资金被划入通道链网络，在全部采用对等出资的情况下，那么每天的交易量

    (100:通道总额 / (3:通道数 * 2:双边对等出资)) * 3:每秒交易量 * 60 * 60 * 24 = 4320000单位

如果是具备收付平账的单向资金流动，最好的情况下资金流量会翻倍：8640000单位。资金利用率上限达到每日8.64万倍，每月260万倍，每年则超过3千万倍。

假设采用千万分之一的转账手续费比例，得出每天的费用总额为0.864单位，不算复利得年净收益率约为 315% 。


四、交易
---

### 1. 基本数据结构
### 2. 多重签名地址
### 3. 层级股权控制地址
### 4. 多方签署
### 5. 支付类别
### 6. 签名剥离
### 7. 手续费
### 8. 标准协议














































51%攻击将导致刚刚脱颖而出的更优质货币处于被劫掠的境地中难以发展壮大，而让差强人意但却因先发优势保持巨大体量的老货币大者恒大。

如果网络加密货币体系中出现了限制准入性银行和部分准备金制度，这将是对所有人最大的讽刺。

bitcoin想要避免系统太过中心化而摒弃了基于IP地址的投票（权益）算法，选择了基于CPU运算竞争的方式，但却没料到定制化芯片（ASIC）的极大优势最终还是造成了严重算力中心化。在一个开放准入自由竞争的领域内，资源和人员的逐渐集中似乎不可完全避免，因为这在经济上具备规模效应从而成本更低更具竞争力。


让某些掌握大量话语权的人或组织投票商议来改变货币体系的核心价值参数的行为和想法是非常愚蠢的，例如修改币量增发的算法、数量或速度。这不是一种类似于宗教原教旨主义的自负行为，而是未来货币系统的关键就在于向大家提供一个不可操控的稳定预期。如果Hacash在某些核心价值参数上的设置极不合理或不适应，那就让更好的来取代吧。

认为货币背后必须有实物支撑或法律背书的想法是错的，认为货币是全部财富或至少是区域财富的衡量或代表是错的，认为货币仅仅只是交易媒介、结算单位或者是方便物物交换的中间状态是错的，认为货币总量有限即会螺旋通缩锁死经济的想法是错的，认为生产货币的成本高于纸币就不值得的想法是错的，认为一个地方只能流通唯一一种货币否则将大幅增加交易成本的想法是错的，认为货币价值必须锚定或保持一个恒定值的想法是错的

新货币通常在国家失去金融权威和信誉的时候走俏

主权信用货币的归宿：纪念币。  

枚、铢、烁、埃、渺


为此系统取名为 Hacash，部分原因是向 HashCash 致敬。

